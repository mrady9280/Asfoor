@page "/agchat"
@using System.ComponentModel
@using System.Text
@using Microsoft.Agents.AI
@using Microsoft.Agents.AI.AGUI
@using Microsoft.Extensions.AI
@using Microsoft.Extensions.Configuration
@inject NavigationManager Nav
@inject IConfiguration Configuration
@implements IDisposable

<PageTitle>Chat</PageTitle>

<ChatHeader OnNewChat="@ResetConversationAsync"/>

<ChatMessageList Messages="@messages" InProgressMessage="@currentResponseMessage">
    <NoMessagesContent>
        <div>To get started, try asking about these example documents. You can replace these with your own data and
            replace this message.
        </div>
        <ChatCitation File="Example_Emergency_Survival_Kit.pdf"/>
        <ChatCitation File="Example_GPS_Watch.md"/>
    </NoMessagesContent>
</ChatMessageList>

<div class="chat-container">
    @* <ChatSuggestions OnSelected="@AddUserMessageAsync" @ref="@chatSuggestions"/> *@
    <ChatInput OnSend="@AddUserMessageAsync" @ref="@chatInput"/>
    @* <SurveyPrompt/> $1$ Remove this line to eliminate the template survey message #1# *@
</div>

@code {


    private int statefulMessageCount;
    private readonly ChatOptions chatOptions = new();
    private readonly List<ChatMessage> messages = new();
    private CancellationTokenSource? currentResponseCancellation;
    private ChatMessage? currentResponseMessage;
    private ChatInput? chatInput;
    private ChatSuggestions? chatSuggestions;
    AIAgent? _agent;
    HttpClient? _httpClient;
    AGUIChatClient? _chatClient;
    private ChatMessage? _currentResponseMessage;

    protected override void OnInitialized()
    {
        statefulMessageCount = 0;
        _httpClient = new HttpClient();
        string apiBaseAddress = Configuration["API_HTTP"] + "/agchat";
        _chatClient = new AGUIChatClient(_httpClient, apiBaseAddress);
        _agent = _chatClient.CreateAIAgent();
    }

    private async Task AddUserMessageAsync(ChatMessage userMessage)
    {
        CancelAnyCurrentResponse();
        // Add the user message to the conversation
        messages.Add(userMessage);
        // chatSuggestions?.Clear();
        await chatInput!.FocusAsync();
        // Stream and display a new response from the IChatClient
        var responseText = new TextContent("");
        currentResponseMessage = new ChatMessage(ChatRole.Assistant, [responseText]);
        currentResponseCancellation = new();
        await foreach (AgentRunResponseUpdate update in _agent.RunStreamingAsync(messages.Skip(statefulMessageCount)))
        {
            foreach (AIContent content in update.Contents)
            {
                switch (content)
                {
                    case TextContent textContent:
                        messages.AddMessages(new ChatResponseUpdate(ChatRole.Assistant, [textContent]), filter: c => c is not TextContent);
                        responseText.Text += update.Text;
                        ChatMessageItem.NotifyChanged(currentResponseMessage);
                        break;
                    case FunctionCallContent functionCallContent:
                        StringBuilder toolCallDetails = new();
                        toolCallDetails.Append($"[Tool Call: {functionCallContent.Name}");
                        if (functionCallContent.Arguments.Any())
                        {
                            toolCallDetails.Append($" (Args: {string.Join(",", functionCallContent.Arguments.Select(x => $"[{x.Key} = {x.Value}]"))}");
                        }

                        toolCallDetails.Append("]");
                        messages.AddMessages(new ChatResponseUpdate(ChatRole.Assistant, [new TextContent(toolCallDetails.ToString())]), filter: c => c is not TextContent);
                        break;
                    case FunctionResultContent functionResultContent:
                        bool isError = functionResultContent.Exception != null;
                        var y = isError ? $"[Tool Error: {functionResultContent.Exception}]" : $"[Tool Result: {functionResultContent.Result}]";
                        messages.AddMessages(new ChatResponseUpdate(ChatRole.Assistant, [new TextContent(y)]), filter: c => c is not TextContent);
                        break;
                    case ErrorContent errorContent:
                        var x = $"[Error: {errorContent.Message}]";
                        messages.AddMessages(new ChatResponseUpdate(ChatRole.Assistant, [new TextContent(x)]), filter: c => c is not TextContent);
                        break;
                }
            }
            
        }

        // Store the final response in the conversation, and begin getting suggestions
        messages.Add(currentResponseMessage!);
        statefulMessageCount = chatOptions.ConversationId is not null ? messages.Count : 0;
        currentResponseMessage = null;
        // chatSuggestions?.Update(messages);
    }

    private void CancelAnyCurrentResponse()
    {
        // If a response was cancelled while streaming, include it in the conversation so it's not lost
        if (currentResponseMessage is not null)
        {
            messages.Add(currentResponseMessage);
        }

        currentResponseCancellation?.Cancel();
        currentResponseMessage = null;
    }

    private async Task ResetConversationAsync()
    {
        CancelAnyCurrentResponse();
        messages.Clear();
        chatOptions.ConversationId = null;
        statefulMessageCount = 0;
        // chatSuggestions?.Clear();
        await chatInput!.FocusAsync();
    }

    public void Dispose()
        => currentResponseCancellation?.Cancel();

}